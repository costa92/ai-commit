# Branches 视图到 Git Log 修复测试指南

## 修复内容总结

我们修复了 Branches 视图切换到 Git Log 时的以下问题：

1. **左侧显示问题**: 现在在 Git Log 视图中会显示选中分支信息和分支列表，而不是导航菜单
2. **分支提交历史过滤**: Git Log 现在会显示选中分支的特定提交历史
3. **标题显示**: Git Log 标题现在会显示当前查看的分支名称

## 修复的核心代码变更

### 1. Branches 视图 (`src/tui_unified/components/views/branches.rs`)
- 添加了 `update_selected_branch_in_state()` 方法来同步选中分支到应用状态

### 2. Git Log 视图 (`src/tui_unified/components/views/git_log.rs`)
- 添加了 `current_branch_filter` 字段来跟踪当前过滤的分支
- 添加了 `set_branch_filter()` 方法来设置分支过滤
- 修改了 `update_title()` 方法来显示分支名称

### 3. 应用主循环 (`src/tui_unified/app.rs`)
- 修改了按键 '1' 的处理逻辑，从 Branches 视图切换时保存选中分支
- 添加了 `get_branch_commits_sync()` 方法来获取特定分支的提交历史
- Git Log 视图现在会根据选中分支过滤提交

### 4. 侧边栏面板 (`src/tui_unified/components/panels/sidebar.rs`)
- 在 Git Log 视图中显示分支列表而不是导航菜单
- 显示当前选中分支的信息
- 高亮显示当前分支和选中分支

## 测试步骤

### 预期行为修复前后对比

**修复前的问题:**
1. 从 Branches 视图按 '1' 切换到 Git Log
2. 左侧仍显示分支列表（不正确）
3. 右侧显示所有提交历史（不是当前分支的）
4. 标题显示 "Git Log"（不显示分支名）

**修复后的正确行为:**
1. 从 Branches 视图选择一个分支，按 '1' 切换到 Git Log
2. 左侧显示选中分支信息和分支列表
3. 右侧显示该分支的提交历史
4. 标题显示 "Git Log - [分支名]"

### 手动测试流程

```bash
# 1. 启动 TUI
./ai-commit --tui-unified

# 2. 进入 Branches 视图（按 '2'）
# 3. 选择一个分支（使用方向键）
# 4. 切换到 Git Log 视图（按 '1'）
# 5. 验证：
#    - 左侧显示选中分支信息
#    - 右侧显示该分支的提交历史
#    - 标题显示分支名称
```

### 功能验证点

1. **分支选择状态保持**: 从分支视图切换时，选中的分支应该被保存
2. **提交历史过滤**: Git Log 应该只显示选中分支的提交
3. **侧边栏正确显示**: 在 Git Log 视图中侧边栏应该显示分支信息
4. **标题更新**: Git Log 标题应该包含分支名称
5. **视觉指示器**: 当前分支和选中分支应该有不同的视觉标识

## 技术实现细节

### 分支提交历史获取
- 使用 `git log [branch_name] --pretty=format:%H╬%an╬%ae╬%ai╬%s --max-count=100`
- 解析输出并创建 Commit 结构体
- 处理日期格式和消息解析

### 状态管理
- 使用 `AppState.selected_items.selected_branch` 跟踪当前选中分支
- 在视图切换时同步分支选择状态
- Git Log 视图根据选中分支过滤显示内容

### 界面适配
- 侧边栏根据当前视图类型显示不同内容
- Git Log 视图中侧边栏显示分支列表而不是导航菜单
- 使用不同的颜色和指示器来区分当前分支和选中分支

## 已知限制

1. **同步获取**: 当前使用同步方式获取分支提交，可能在大型仓库中有性能影响
2. **简化字段**: Commit 结构体中的一些字段使用默认值或简化处理
3. **错误处理**: 如果 git 命令失败，会回退到显示所有提交

## 后续改进建议

1. **异步处理**: 将分支提交获取改为异步处理
2. **缓存机制**: 添加分支提交历史的缓存
3. **更多 git 信息**: 获取更完整的 git 信息（如文件变更统计）
4. **用户体验**: 添加加载状态指示器