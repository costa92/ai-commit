# TUIç•Œé¢æ•´åˆæŠ€æœ¯è®¾è®¡æ–‡æ¡£

## æ¦‚è¿°

åŸºäº `TUI_INTEGRATION_ANALYSIS.md` çš„åˆ†æç»“æœï¼Œæœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº†ç»Ÿä¸€TUIç•Œé¢çš„æŠ€æœ¯æ¶æ„ã€æ¨¡å—è®¾è®¡å’Œå®ç°æ–¹æ¡ˆã€‚

## æŠ€æœ¯æ¶æ„è®¾è®¡

### ğŸ—ï¸ æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            TUI Unified Application                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚              â”‚  â”‚                  â”‚  â”‚                  â”‚              â”‚
â”‚  â”‚   Sidebar    â”‚  â”‚   Main Content   â”‚  â”‚   Detail Panel   â”‚              â”‚
â”‚  â”‚   Panel      â”‚  â”‚     Panel        â”‚  â”‚                  â”‚              â”‚
â”‚  â”‚   (20%)      â”‚  â”‚     (50%)        â”‚  â”‚     (30%)        â”‚              â”‚
â”‚  â”‚              â”‚  â”‚                  â”‚  â”‚                  â”‚              â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚              â”‚
â”‚  â”‚ â”‚Menu Itemsâ”‚ â”‚  â”‚ â”‚Dynamic       â”‚ â”‚  â”‚ â”‚Info Panel   â”‚ â”‚              â”‚
â”‚  â”‚ â”‚  â€¢ Logs  â”‚ â”‚  â”‚ â”‚Content       â”‚ â”‚  â”‚ â”‚              â”‚ â”‚              â”‚
â”‚  â”‚ â”‚  â€¢ Branchâ”‚ â”‚  â”‚ â”‚              â”‚ â”‚  â”‚ â”‚(40% height)  â”‚ â”‚              â”‚
â”‚  â”‚ â”‚  â€¢ Tags  â”‚ â”‚  â”‚ â”‚              â”‚ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚              â”‚
â”‚  â”‚ â”‚  â€¢ Remoteâ”‚ â”‚  â”‚ â”‚              â”‚ â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚              â”‚
â”‚  â”‚ â”‚  â€¢ Stash â”‚ â”‚  â”‚ â”‚              â”‚ â”‚  â”‚ â”‚Diff Viewer   â”‚ â”‚              â”‚
â”‚  â”‚ â”‚  â€¢ Hist  â”‚ â”‚  â”‚ â”‚              â”‚ â”‚  â”‚ â”‚              â”‚ â”‚              â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â”‚(60% height)  â”‚ â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚              â”‚
â”‚                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                       Smart Status Bar & Help System                        â”‚
â”‚  [Focus] [Operation] [KeyHints] [Selection] [Mode] [Git Status] [Help]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                              â†‘ Layout Manager â†“
                              
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              Core Application Layer                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Event System  â”‚  State Manager  â”‚  Git Integrationâ”‚    Component System     â”‚
â”‚                 â”‚                 â”‚                 â”‚                         â”‚
â”‚ â€¢ Input Handler â”‚ â€¢ Focus Manager â”‚ â€¢ Git Commands  â”‚ â€¢ Sidebar Components    â”‚
â”‚ â€¢ Key Bindings  â”‚ â€¢ View Stack    â”‚ â€¢ Data Caching  â”‚ â€¢ Content Components    â”‚
â”‚ â€¢ Event Router  â”‚ â€¢ Config State  â”‚ â€¢ Async Ops     â”‚ â€¢ Detail Components     â”‚
â”‚ â€¢ Hot Reload    â”‚ â€¢ UI State      â”‚ â€¢ Error Handle  â”‚ â€¢ Diff Viewer           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                              â†‘ Data Layer â†“
                              
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                Data & Git Layer                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Git Commands  â”‚   Data Models   â”‚   Cache System  â”‚       File System       â”‚
â”‚                 â”‚                 â”‚                 â”‚                         â”‚
â”‚ â€¢ git log       â”‚ â€¢ Commit        â”‚ â€¢ LRU Cache     â”‚ â€¢ Config Files          â”‚
â”‚ â€¢ git branch    â”‚ â€¢ Branch        â”‚ â€¢ Memory Cache  â”‚ â€¢ Git Repository        â”‚
â”‚ â€¢ git diff      â”‚ â€¢ Tag           â”‚ â€¢ Command Cache â”‚ â€¢ Stash Files           â”‚
â”‚ â€¢ git stash     â”‚ â€¢ Remote        â”‚ â€¢ Result Cache  â”‚ â€¢ Temp Files            â”‚
â”‚ â€¢ git status    â”‚ â€¢ Diff          â”‚ â€¢ Smart Refresh â”‚ â€¢ User Preferences      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ§© æ ¸å¿ƒæ¨¡å—æ¶æ„

#### 1. å¸ƒå±€ç®¡ç†ç³»ç»Ÿ (Layout Manager)

```rust
// src/tui_unified/layout.rs
pub struct LayoutManager {
    pub sidebar_width: u16,      // 20% 
    pub content_width: u16,      // 50%
    pub detail_width: u16,       // 30%
    pub mode: LayoutMode,        // Normal | SplitHorizontal | SplitVertical | FullScreen
}

pub enum LayoutMode {
    Normal,           // æ ‡å‡†ä¸‰æ å¸ƒå±€
    SplitHorizontal,  // æ°´å¹³åˆ†å±
    SplitVertical,    // å‚ç›´åˆ†å±  
    FullScreen,       // å…¨å±diffæ¨¡å¼
}
```

#### 2. ç„¦ç‚¹ç®¡ç†ç³»ç»Ÿ (Focus Manager)

```rust
// src/tui_unified/focus.rs
pub struct FocusManager {
    pub current_panel: FocusPanel,
    pub panel_history: Vec<FocusPanel>,
    pub focus_ring: [FocusPanel; 3],
}

pub enum FocusPanel {
    Sidebar,    // ä¾§è¾¹æ  (ç„¦ç‚¹0)
    Content,    // ä¸»å†…å®¹ (ç„¦ç‚¹1) 
    Detail,     // è¯¦æƒ…åŒº (ç„¦ç‚¹2)
}

// ç„¦ç‚¹åˆ‡æ¢é€»è¾‘: Tabé”®é¡ºåºåˆ‡æ¢, Shift+Tabåå‘åˆ‡æ¢
impl FocusManager {
    pub fn next_focus(&mut self) -> FocusPanel { /* Tab */ }
    pub fn prev_focus(&mut self) -> FocusPanel { /* Shift+Tab */ }
    pub fn direct_focus(&mut self, panel: FocusPanel) { /* ç›´æ¥è·³è½¬ */ }
}
```

#### 3. çŠ¶æ€ç®¡ç†ç³»ç»Ÿ (State Manager)

```rust
// src/tui_unified/state.rs
pub struct AppState {
    // UIçŠ¶æ€
    pub layout: LayoutManager,
    pub focus: FocusManager,
    pub current_view: ViewType,
    
    // Gitæ•°æ®çŠ¶æ€
    pub repo_state: GitRepoState,
    pub selected_items: SelectionState,
    
    // é…ç½®çŠ¶æ€
    pub config: AppConfig,
    pub key_bindings: KeyBindings,
}

pub enum ViewType {
    GitLog,
    Branches,
    Tags,
    Remotes,
    Stash,
    QueryHistory,
}
```

#### 4. ç»„ä»¶ç³»ç»Ÿæ¶æ„

```rust
// src/tui_unified/components/
pub trait Component {
    fn render(&mut self, frame: &mut Frame, area: Rect, state: &AppState);
    fn handle_event(&mut self, event: &KeyEvent, state: &mut AppState) -> bool;
    fn update_data(&mut self, state: &AppState);
}

// ä¸»è¦ç»„ä»¶
pub struct SidebarComponent;      // å·¦ä¾§èœå•
pub struct ContentComponent;      // ä¸­é—´å†…å®¹ 
pub struct DetailComponent;       // å³ä¾§è¯¦æƒ…
pub struct DiffViewerComponent;   // ä¸“ä¸šdiffæŸ¥çœ‹å™¨
pub struct StatusBarComponent;    // çŠ¶æ€æ 
```

## æ ¸å¿ƒåŠŸèƒ½æ¨¡å—è®¾è®¡

### ğŸ“‹ ä¾§è¾¹æ é¢æ¿ (Sidebar Panel)

```rust
// src/tui_unified/panels/sidebar.rs
pub struct SidebarPanel {
    pub menu_items: Vec<MenuItem>,
    pub selected_index: usize,
    pub expanded_items: HashSet<usize>,
}

pub struct MenuItem {
    pub name: String,
    pub icon: &'static str,
    pub view_type: ViewType,
    pub shortcut: Option<char>,
    pub children: Vec<MenuItem>,    // æ”¯æŒå­èœå•
    pub badge: Option<String>,      // çŠ¶æ€æ ‡è®° (å¦‚åˆ†æ”¯æ•°é‡)
}

// èœå•é¡¹é…ç½®
let menu_items = vec![
    MenuItem::new("ğŸ“‹ Git Log", ViewType::GitLog, Some('1')),
    MenuItem::new("ğŸŒ¿ Branches", ViewType::Branches, Some('2')),
    MenuItem::new("ğŸ·ï¸ Tags", ViewType::Tags, Some('3')),
    MenuItem::new("ğŸŒ Remotes", ViewType::Remotes, Some('4')),
    MenuItem::new("ğŸ“¦ Stash", ViewType::Stash, Some('5')),
    MenuItem::new("ğŸ“ Query History", ViewType::QueryHistory, Some('6')),
];
```

### ğŸ“Š ä¸»å†…å®¹é¢æ¿ (Main Content Panel)

```rust
// src/tui_unified/panels/content.rs
pub struct ContentPanel {
    pub current_view: ViewType,
    pub git_log_view: GitLogView,
    pub branches_view: BranchesView, 
    pub tags_view: TagsView,
    pub remotes_view: RemotesView,
    pub stash_view: StashView,
    pub history_view: QueryHistoryView,
}

// åŠ¨æ€å†…å®¹åˆ‡æ¢
impl ContentPanel {
    pub fn render_current_view(&mut self, frame: &mut Frame, area: Rect, state: &AppState) {
        match state.current_view {
            ViewType::GitLog => self.git_log_view.render(frame, area, state),
            ViewType::Branches => self.branches_view.render(frame, area, state),
            ViewType::Tags => self.tags_view.render(frame, area, state),
            // ... å…¶ä»–è§†å›¾
        }
    }
}
```

### ğŸ” è¯¦æƒ…é¢æ¿ (Detail Panel)

```rust
// src/tui_unified/panels/detail.rs
pub struct DetailPanel {
    pub info_panel: InfoPanel,      // ä¸Šéƒ¨40% - ä¿¡æ¯å±•ç¤º
    pub diff_panel: DiffPanel,      // ä¸‹éƒ¨60% - diffæ˜¾ç¤º
    pub split_ratio: (u16, u16),    // (40, 60) å¯è°ƒèŠ‚
}

pub struct InfoPanel {
    pub content: InfoContent,
    pub scroll_offset: usize,
}

pub enum InfoContent {
    CommitInfo(CommitDetails),
    BranchInfo(BranchDetails),
    TagInfo(TagDetails),
    RemoteInfo(RemoteDetails),
    StashInfo(StashDetails),
}

pub struct DiffPanel {
    pub diff_content: String,
    pub syntax_highlighting: bool,
    pub view_mode: DiffViewMode,
}

pub enum DiffViewMode {
    Unified,        // ç»Ÿä¸€diff
    SideBySide,     // å¹¶æ’å¯¹æ¯”
    TreeView,       // æ–‡ä»¶æ ‘å½¢è§†å›¾
}
```

## æ•°æ®æµç¨‹è®¾è®¡

### ğŸ”„ åº”ç”¨å¯åŠ¨æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   App Launch    â”‚â”€â”€â”€â–¶â”‚  Load Config     â”‚â”€â”€â”€â–¶â”‚  Init Git Repo  â”‚
â”‚                 â”‚    â”‚  - Keys Config   â”‚    â”‚  - Repo Check   â”‚
â”‚                 â”‚    â”‚  - Theme Config  â”‚    â”‚  - Branch List  â”‚
â”‚                 â”‚    â”‚  - Layout Prefs  â”‚    â”‚  - Initial Data â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â–¼
â”‚   Render Loop   â”‚â—€â”€â”€â”€â”‚  Setup UI State  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 â”‚    â”‚  - Focus: Sidebarâ”‚    â”‚  Setup Event    â”‚
â”‚                 â”‚    â”‚  - View: GitLog  â”‚    â”‚  - Key Handler  â”‚
â”‚                 â”‚    â”‚  - Layout: Normalâ”‚    â”‚  - Git Watcher  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ¯ äº‹ä»¶å¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User Input     â”‚â”€â”€â”€â–¶â”‚  Event Router    â”‚â”€â”€â”€â–¶â”‚  Component      â”‚
â”‚  - Key Press    â”‚    â”‚                  â”‚    â”‚  Event Handler  â”‚
â”‚  - Mouse Click  â”‚    â”‚  Router Logic:   â”‚    â”‚                 â”‚
â”‚  - Terminal     â”‚    â”‚  â”œâ”€ Global Keys  â”‚    â”‚  Handle Logic:  â”‚
â”‚    Resize       â”‚    â”‚  â”œâ”€ Panel Keys   â”‚    â”‚  â”œâ”€ Update Data â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â””â”€ Context Keys â”‚    â”‚  â”œâ”€ Change View â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â””â”€ Git Command â”‚
                                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â–¼
â”‚   UI Update     â”‚â—€â”€â”€â”€â”‚   State Update   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 â”‚    â”‚                  â”‚    â”‚  Side Effects   â”‚
â”‚ â”œâ”€ Render Comp  â”‚    â”‚ â”œâ”€ Focus Change  â”‚    â”‚                 â”‚
â”‚ â”œâ”€ Update Cache â”‚    â”‚ â”œâ”€ Data Refresh  â”‚    â”‚ â”œâ”€ Git Commands â”‚
â”‚ â””â”€ Status Bar   â”‚    â”‚ â””â”€ Config Save   â”‚    â”‚ â”œâ”€ File I/O     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â””â”€ Cache Update â”‚
                                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸš€ Gitæ“ä½œå¼‚æ­¥æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Git Command   â”‚â”€â”€â”€â–¶â”‚   Async Executor â”‚â”€â”€â”€â–¶â”‚   Cache Check   â”‚
â”‚                 â”‚    â”‚                  â”‚    â”‚                 â”‚
â”‚  Examples:      â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”œâ”€ Hit: Return  â”‚
â”‚  â€¢ git log      â”‚    â”‚ â”‚ Tokio Spawn  â”‚ â”‚    â”‚ â”‚   Cached Data â”‚
â”‚  â€¢ git branch   â”‚    â”‚ â”‚ Background   â”‚ â”‚    â”‚ â””â”€ Miss: Exec   â”‚
â”‚  â€¢ git diff     â”‚    â”‚ â”‚ Execution    â”‚ â”‚    â”‚     Git Command â”‚
â”‚  â€¢ git stash    â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â–¼
â”‚   UI Progress   â”‚â—€â”€â”€â”€â”‚  Result Process  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 â”‚    â”‚                  â”‚    â”‚  Command Exec   â”‚
â”‚ â”œâ”€ Loading Bar  â”‚    â”‚ â”œâ”€ Parse Output  â”‚    â”‚                 â”‚
â”‚ â”œâ”€ Spinner      â”‚    â”‚ â”œâ”€ Update Cache  â”‚    â”‚ â”œâ”€ Execute      â”‚
â”‚ â””â”€ Status Text  â”‚    â”‚ â”œâ”€ Error Handle  â”‚    â”‚ â”œâ”€ Stream Parse â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â””â”€ Notify UI     â”‚    â”‚ â””â”€ Error Catch  â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å…³é”®ç®—æ³•è®¾è®¡

### ğŸ” æ™ºèƒ½åˆ†æ”¯æ“ä½œç®—æ³•

```rust
// src/tui_unified/algorithms/smart_branch.rs
pub struct SmartBranchManager {
    cache: BranchCache,
    remote_status: HashMap<String, RemoteStatus>,
}

impl SmartBranchManager {
    // ä¸€é”®åˆ‡æ¢+æ‹‰å–ç®—æ³•
    pub async fn smart_checkout_and_pull(&self, branch: &str) -> Result<()> {
        // 1. æ£€æŸ¥å·¥ä½œåŒºçŠ¶æ€
        let work_tree_clean = self.check_work_tree_status().await?;
        if !work_tree_clean {
            return Err("Working tree has uncommitted changes".into());
        }
        
        // 2. æ£€æŸ¥è¿œç¨‹çŠ¶æ€ 
        let remote_status = self.get_remote_status(branch).await?;
        let needs_pull = matches!(remote_status, RemoteStatus::Behind(_));
        
        // 3. æ‰§è¡Œåˆ‡æ¢
        self.git_checkout(branch).await?;
        
        // 4. è‡ªåŠ¨æ‹‰å–(å¦‚æœéœ€è¦)
        if needs_pull {
            self.git_pull().await?;
        }
        
        // 5. æ›´æ–°ç¼“å­˜
        self.refresh_cache().await?;
        
        Ok(())
    }
    
    // åˆ†æ”¯å¥åº·åº¦æ£€æµ‹
    pub async fn calculate_branch_health(&self, branch: &str) -> BranchHealth {
        let mut score = 100;
        let mut issues = Vec::new();
        
        // æ£€æŸ¥æ˜¯å¦è½åäºè¿œç¨‹
        if let Ok(status) = self.get_remote_status(branch).await {
            match status {
                RemoteStatus::Behind(commits) => {
                    score -= commits * 5; // æ¯ä¸ªè½åæäº¤æ‰£5åˆ†
                    issues.push(format!("Behind by {} commits", commits));
                }
                RemoteStatus::Diverged(ahead, behind) => {
                    score -= (ahead + behind) * 3;
                    issues.push(format!("Diverged: +{} -{}", ahead, behind));
                }
                _ => {}
            }
        }
        
        // æ£€æŸ¥æ˜¯å¦æœ‰æœªæ¨é€çš„æäº¤
        if let Ok(unpushed) = self.count_unpushed_commits(branch).await {
            if unpushed > 10 {
                score -= 20;
                issues.push(format!("{} unpushed commits", unpushed));
            }
        }
        
        BranchHealth { score, issues }
    }
}
```

### ğŸ“ˆ è™šæ‹Ÿæ»šåŠ¨ç®—æ³• (å¤§ä»“åº“ä¼˜åŒ–)

```rust
// src/tui_unified/algorithms/virtual_scroll.rs
pub struct VirtualScrollManager<T> {
    items: Vec<T>,
    visible_range: (usize, usize),
    viewport_height: usize,
    scroll_offset: usize,
    buffer_size: usize, // ç¼“å†²åŒºå¤§å°
}

impl<T> VirtualScrollManager<T> {
    pub fn new(viewport_height: usize) -> Self {
        Self {
            items: Vec::new(),
            visible_range: (0, 0),
            viewport_height,
            scroll_offset: 0,
            buffer_size: viewport_height * 2, // ç¼“å†²åŒºæ˜¯å¯è§†åŒºåŸŸçš„2å€
        }
    }
    
    // è®¡ç®—å¯è§èŒƒå›´
    pub fn calculate_visible_range(&mut self) {
        let start = self.scroll_offset.saturating_sub(self.buffer_size / 2);
        let end = (self.scroll_offset + self.viewport_height + self.buffer_size / 2)
            .min(self.items.len());
        self.visible_range = (start, end);
    }
    
    // è·å–å¯è§é¡¹ç›®
    pub fn get_visible_items(&self) -> &[T] {
        let (start, end) = self.visible_range;
        &self.items[start..end]
    }
    
    // æ»šåŠ¨åˆ°æŒ‡å®šä½ç½®
    pub fn scroll_to(&mut self, index: usize) {
        self.scroll_offset = index;
        self.calculate_visible_range();
    }
}
```

### ğŸ” æ™ºèƒ½æœç´¢ç®—æ³•

```rust
// src/tui_unified/algorithms/smart_search.rs
pub struct SmartSearchEngine {
    index: SearchIndex,
    filters: Vec<SearchFilter>,
}

pub struct SearchIndex {
    commit_messages: HashMap<String, Vec<CommitId>>,
    authors: HashMap<String, Vec<CommitId>>,
    files: HashMap<PathBuf, Vec<CommitId>>,
    full_text: Option<TantivyIndex>, // å¯é€‰çš„å…¨æ–‡æœç´¢å¼•æ“
}

impl SmartSearchEngine {
    // å¤åˆæ¡ä»¶æœç´¢
    pub async fn search(&self, query: &SearchQuery) -> Vec<SearchResult> {
        let mut results = Vec::new();
        
        // 1. æ–‡æœ¬æœç´¢
        if let Some(text) = &query.text {
            results.extend(self.search_text(text).await?);
        }
        
        // 2. ä½œè€…è¿‡æ»¤
        if let Some(author) = &query.author {
            results = self.filter_by_author(results, author);
        }
        
        // 3. æ—¶é—´èŒƒå›´è¿‡æ»¤
        if let Some(date_range) = &query.date_range {
            results = self.filter_by_date_range(results, date_range);
        }
        
        // 4. æ–‡ä»¶è·¯å¾„è¿‡æ»¤
        if let Some(path) = &query.file_path {
            results = self.filter_by_file_path(results, path);
        }
        
        // 5. ç»“æœæ’åºå’Œå»é‡
        results.sort_by(|a, b| b.relevance_score.cmp(&a.relevance_score));
        results.dedup_by_key(|r| r.commit_id);
        
        results
    }
}
```

## APIæ¥å£è®¾è®¡

### ğŸ”§ Gitæ“ä½œæ¥å£

```rust
// src/tui_unified/git/interface.rs
#[async_trait]
pub trait GitInterface {
    // åŸºç¡€Gitæ“ä½œ
    async fn get_commits(&self, branch: Option<&str>, limit: Option<usize>) -> Result<Vec<Commit>>;
    async fn get_branches(&self) -> Result<Vec<Branch>>;
    async fn get_tags(&self) -> Result<Vec<Tag>>;
    async fn get_remotes(&self) -> Result<Vec<Remote>>;
    async fn get_stash_list(&self) -> Result<Vec<Stash>>;
    
    // åˆ†æ”¯æ“ä½œ
    async fn checkout_branch(&self, branch: &str) -> Result<()>;
    async fn create_branch(&self, name: &str, base: Option<&str>) -> Result<()>;
    async fn delete_branch(&self, name: &str, force: bool) -> Result<()>;
    async fn pull_branch(&self, branch: Option<&str>) -> Result<()>;
    async fn push_branch(&self, branch: &str, force: bool) -> Result<()>;
    
    // Diffæ“ä½œ
    async fn get_commit_diff(&self, commit: &str) -> Result<String>;
    async fn get_file_diff(&self, file: &Path, base: Option<&str>) -> Result<String>;
    async fn get_staged_diff(&self) -> Result<String>;
    
    // Stashæ“ä½œ
    async fn stash_save(&self, message: Option<&str>) -> Result<()>;
    async fn stash_apply(&self, index: usize) -> Result<()>;
    async fn stash_drop(&self, index: usize) -> Result<()>;
    async fn stash_show(&self, index: usize) -> Result<String>;
}

// å®ç°Gitæ¥å£
pub struct AsyncGitImpl {
    repo_path: PathBuf,
    command_cache: Arc<RwLock<HashMap<String, CachedResult>>>,
}

#[async_trait]
impl GitInterface for AsyncGitImpl {
    async fn get_commits(&self, branch: Option<&str>, limit: Option<usize>) -> Result<Vec<Commit>> {
        let cache_key = format!("commits_{}_{}", branch.unwrap_or("HEAD"), limit.unwrap_or(100));
        
        // æ£€æŸ¥ç¼“å­˜
        if let Some(cached) = self.get_cached_result(&cache_key).await? {
            return Ok(cached);
        }
        
        // æ‰§è¡ŒGitå‘½ä»¤
        let mut cmd = tokio::process::Command::new("git");
        cmd.arg("log")
           .arg("--format=%H|%an|%ae|%at|%s")
           .current_dir(&self.repo_path);
           
        if let Some(branch) = branch {
            cmd.arg(branch);
        }
        
        if let Some(limit) = limit {
            cmd.arg(format!("-{}", limit));
        }
        
        let output = cmd.output().await?;
        let commits = self.parse_commit_output(&output.stdout)?;
        
        // ç¼“å­˜ç»“æœ
        self.cache_result(&cache_key, &commits, Duration::from_secs(60)).await?;
        
        Ok(commits)
    }
}
```

### ğŸ¨ ç»„ä»¶æ¥å£è®¾è®¡

```rust
// src/tui_unified/components/interface.rs
pub trait ComponentInterface {
    type Props;
    type State;
    
    // ç»„ä»¶ç”Ÿå‘½å‘¨æœŸ
    fn new(props: Self::Props) -> Self;
    fn mount(&mut self, state: &AppState);
    fn unmount(&mut self);
    
    // æ¸²æŸ“æ¥å£
    fn render(&mut self, frame: &mut Frame, area: Rect, state: &AppState);
    fn get_cursor_position(&self) -> Option<(u16, u16)>;
    
    // äº‹ä»¶å¤„ç†
    fn handle_key_event(&mut self, key: KeyEvent, state: &mut AppState) -> EventResult;
    fn handle_mouse_event(&mut self, mouse: MouseEvent, state: &mut AppState) -> EventResult;
    fn handle_custom_event(&mut self, event: CustomEvent, state: &mut AppState) -> EventResult;
    
    // æ•°æ®æ›´æ–°
    fn should_update(&self, old_state: &AppState, new_state: &AppState) -> bool;
    fn update(&mut self, state: &AppState);
    
    // ç„¦ç‚¹ç®¡ç†
    fn can_focus(&self) -> bool { true }
    fn on_focus(&mut self, state: &AppState);
    fn on_blur(&mut self, state: &AppState);
}

pub enum EventResult {
    Handled,
    NotHandled,
    Bubble,     // ç»§ç»­å‘ä¸Šä¼ æ’­
    Navigate(Navigation), // å¯¼èˆªåˆ°å…¶ä»–ç»„ä»¶
}

pub enum Navigation {
    NextPanel,
    PrevPanel,
    ToPanel(FocusPanel),
    ToView(ViewType),
}
```

## æ€§èƒ½ä¼˜åŒ–è®¾è®¡

### âš¡ ç¼“å­˜ç³»ç»Ÿè®¾è®¡

```rust
// src/tui_unified/cache/mod.rs
pub struct CacheManager {
    pub git_cache: GitCache,
    pub ui_cache: UiCache,
    pub file_cache: FileCache,
}

pub struct GitCache {
    commits: LruCache<String, Vec<Commit>>,
    branches: LruCache<String, Vec<Branch>>,
    diffs: LruCache<String, String>,
    ttl: HashMap<String, Instant>,
}

impl GitCache {
    pub fn new(capacity: usize) -> Self {
        Self {
            commits: LruCache::new(capacity),
            branches: LruCache::new(capacity / 2),
            diffs: LruCache::new(capacity),
            ttl: HashMap::new(),
        }
    }
    
    pub fn get<T: Clone>(&mut self, key: &str) -> Option<T> {
        // æ£€æŸ¥TTL
        if let Some(expire_time) = self.ttl.get(key) {
            if Instant::now() > *expire_time {
                self.invalidate(key);
                return None;
            }
        }
        
        // ä»å¯¹åº”ç¼“å­˜è·å–
        if key.starts_with("commits_") {
            self.commits.get(key).cloned()
        } else if key.starts_with("branches_") {
            self.branches.get(key).cloned()
        } else if key.starts_with("diff_") {
            self.diffs.get(key).cloned()
        } else {
            None
        }
    }
    
    pub fn set<T: Clone>(&mut self, key: String, value: T, ttl: Duration) {
        let expire_time = Instant::now() + ttl;
        self.ttl.insert(key.clone(), expire_time);
        
        if key.starts_with("commits_") {
            if let Ok(commits) = bincode::serialize(&value) {
                self.commits.put(key, commits);
            }
        }
        // ... å…¶ä»–ç¼“å­˜ç±»å‹
    }
}
```

### ğŸ”„ å¼‚æ­¥å¤„ç†ä¼˜åŒ–

```rust
// src/tui_unified/async_manager.rs
pub struct AsyncTaskManager {
    runtime: tokio::runtime::Handle,
    active_tasks: Arc<RwLock<HashMap<TaskId, JoinHandle<()>>>>,
    task_counter: Arc<AtomicU64>,
}

impl AsyncTaskManager {
    pub fn spawn_git_task<F, T>(&self, name: &str, future: F) -> TaskId 
    where
        F: Future<Output = Result<T>> + Send + 'static,
        T: Send + 'static,
    {
        let task_id = TaskId(self.task_counter.fetch_add(1, Ordering::SeqCst));
        let active_tasks = Arc::clone(&self.active_tasks);
        
        let handle = self.runtime.spawn(async move {
            match future.await {
                Ok(result) => {
                    // å‘é€ç»“æœåˆ°UIçº¿ç¨‹
                    EventBus::publish(TaskComplete { task_id, result });
                }
                Err(err) => {
                    // å‘é€é”™è¯¯åˆ°UIçº¿ç¨‹
                    EventBus::publish(TaskError { task_id, error: err });
                }
            }
            
            // æ¸…ç†ä»»åŠ¡
            active_tasks.write().await.remove(&task_id);
        });
        
        self.active_tasks.write().unwrap().insert(task_id, handle);
        task_id
    }
    
    pub fn cancel_task(&self, task_id: TaskId) {
        if let Some(handle) = self.active_tasks.write().unwrap().remove(&task_id) {
            handle.abort();
        }
    }
}
```

è¿™ä¸ªæŠ€æœ¯è®¾è®¡æ–‡æ¡£æä¾›äº†å®Œæ•´çš„æ¶æ„è®¾è®¡ã€æ¨¡å—åˆ’åˆ†ã€æ•°æ®æµç¨‹ã€ç®—æ³•è®¾è®¡å’Œæ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆï¼Œä¸ºTUIç•Œé¢æ•´åˆæä¾›äº†è¯¦ç»†çš„æŠ€æœ¯æŒ‡å¯¼ã€‚
