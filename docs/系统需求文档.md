# AI-Commit 系统需求文档

## 1. 项目概述

### 1.1 项目背景
AI-Commit 是一个基于人工智能的 Git 提交信息生成工具，旨在帮助开发者自动生成符合 Conventional Commits 规范的高质量提交信息。

### 1.2 项目目标
- 提高开发效率，减少手动编写 commit message 的时间
- 确保提交信息符合 Conventional Commits 规范
- 支持多种 AI 服务提供商（Ollama、Deepseek、SiliconFlow）
- 智能处理大型和多文件变更场景
- 提供多语言支持（中文、英文）

### 1.3 技术栈
- **编程语言**: Rust
- **异步运行时**: Tokio
- **HTTP 客户端**: Reqwest
- **命令行解析**: Clap
- **配置管理**: 环境变量 + .env 文件
- **国际化**: 自定义 i18n 模块
- **测试框架**: Rust 内置测试框架

## 2. 功能需求

### 2.1 核心功能需求

#### 2.1.1 自动提交信息生成 (FR-001)
**描述**: 基于 git diff 自动生成符合 Conventional Commits 规范的提交信息

**输入**: 
- Git 暂存区变更内容 (`git diff --cached`)
- 用户配置参数

**输出**: 
- 格式化的提交信息：`<type>(<scope>): <subject>`
- 中文描述，不超过50字符

**验收标准**:
- 生成的提交信息必须符合 Conventional Commits 规范
- 支持的类型：feat, fix, docs, style, refactor, test, chore
- 自动推断合适的 scope 和 type
- 提交信息必须为中文

#### 2.1.2 多AI服务提供商支持 (FR-002)
**描述**: 支持多种 AI 服务提供商，用户可灵活选择

**支持的提供商**:
1. **Ollama** (默认)
   - 本地部署，数据隐私性好
   - 默认模型：mistral
   - 默认端点：http://localhost:11434/api/generate

2. **Deepseek**
   - 云端服务，响应速度快
   - 需要 API Key
   - 端点：https://api.deepseek.com/v1/chat/completions

3. **SiliconFlow**
   - 云端服务，支持多种模型
   - 需要 API Key
   - 端点：https://api.siliconflow.cn/v1/chat/completions

**验收标准**:
- 用户可通过配置切换不同的AI服务提供商
- 所有提供商都支持流式响应
- 统一的错误处理和重试机制

#### 2.1.3 智能大文件与多文件变更处理 (FR-003)
**描述**: 针对大型变更和多文件变更进行智能分析和摘要

**触发条件**:
- 大文件：diff 内容超过 10,000 字符
- 多文件：涉及文件数量超过 5 个

**处理逻辑**:
1. **Diff 分析引擎**
   - 解析文件路径和变更统计
   - 统计添加/删除行数
   - 识别变更类型（新增/修改/删除）

2. **智能作用域推断**
   - 基于文件路径自动推断 scope
   - 优先级：src/ > 具体模块 > 顶级目录
   - 特殊处理：tests -> test, docs -> docs

3. **变更类型推断**
   - 基于文件变更模式推断 type
   - 新增文件 -> feat
   - 测试文件变更 -> test
   - 文档文件变更 -> docs
   - 其他修改 -> refactor

**验收标准**:
- 系统能自动检测大型变更并提供摘要
- 生成的提交信息避免罗列具体文件名
- 突出整体变更目标和核心价值

#### 2.1.4 Tag 管理功能 (FR-004)
**描述**: 支持智能版本标签创建和管理

**功能特性**:
- 语义化版本管理 (SemVer)
- 自动版本递增
- 冲突检测和解决
- 支持自定义标签消息

**版本解析规则**:
- 未指定版本：从最新标签递增 patch 版本
- 指定 major.minor：从 .0 patch 开始查找可用版本
- 指定完整版本：检查可用性，冲突时自动递增

**验收标准**:
- 支持创建语义化版本标签
- 自动处理版本冲突
- 可选择是否推送到远程仓库

### 2.2 配置管理需求

#### 2.2.1 多层级配置系统 (FR-005)
**描述**: 支持多种配置来源，按优先级加载

**配置优先级** (高到低):
1. 命令行参数
2. 环境变量 (前缀 `AI_COMMIT_`)
3. 用户配置文件 (`~/.ai-commit/.env`)
4. 项目配置文件 (`.env`)
5. 默认值

**配置项**:
```bash
# AI 服务提供商配置
AI_COMMIT_PROVIDER=ollama          # ollama|deepseek|siliconflow
AI_COMMIT_MODEL=mistral            # 模型名称

# Ollama 配置
AI_COMMIT_OLLAMA_URL=http://localhost:11434/api/generate

# Deepseek 配置  
AI_COMMIT_DEEPSEEK_API_KEY=sk-xxx  # API密钥
AI_COMMIT_DEEPSEEK_URL=https://api.deepseek.com/v1/chat/completions

# SiliconFlow 配置
AI_COMMIT_SILICONFLOW_API_KEY=sk-xxx
AI_COMMIT_SILICONFLOW_URL=https://api.siliconflow.cn/v1/chat/completions

# 国际化配置
AI_COMMIT_LANGUAGE=zh-cn           # zh-cn|zh-tw|en
```

**验收标准**:
- 配置系统支持所有定义的优先级
- 环境变量自动加载和缓存
- 配置验证和错误提示

### 2.3 国际化需求

#### 2.3.1 多语言支持 (FR-006)
**描述**: 支持多种语言界面和消息

**支持语言**:
- 简体中文 (zh-cn) - 默认
- 繁体中文 (zh-tw)
- 英语 (en)

**国际化范围**:
- 命令行帮助信息
- 错误提示消息
- 系统状态消息
- 日志输出信息

**验收标准**:
- 用户可通过配置切换语言
- 所有用户可见的文本都支持国际化
- 语言切换即时生效

## 3. 非功能需求

### 3.1 性能需求 (NFR-001)

#### 3.1.1 响应时间
- **正常场景**: 小型变更（<1000字符）处理时间 < 5 秒
- **大型场景**: 大型变更（>10000字符）处理时间 < 15 秒
- **网络延迟**: 云端AI服务响应时间 < 10 秒

#### 3.1.2 资源使用
- **内存占用**: 程序运行时内存占用 < 50MB
- **CPU 使用**: 正常处理时 CPU 占用 < 20%
- **并发支持**: 支持多个进程同时运行（通过文件锁机制）

#### 3.1.3 性能优化策略
- HTTP 客户端连接复用（连接池）
- 正则表达式预编译
- 流式响应处理
- 环境变量缓存机制
- Git 命令结果缓存

### 3.2 可靠性需求 (NFR-002)

#### 3.2.1 错误处理
- **网络错误**: 自动重试机制，最多重试3次
- **API 错误**: 清晰的错误信息和解决建议
- **Git 错误**: 检测 Git 仓库状态，提供操作指导

#### 3.2.2 数据完整性
- **配置验证**: 启动时验证必要的配置项
- **输入验证**: 验证 Git diff 内容有效性
- **输出验证**: 确保生成的提交信息符合规范

#### 3.2.3 容灾机制
- **服务降级**: AI 服务不可用时提供手动输入选项
- **配置恢复**: 配置文件损坏时使用默认配置
- **状态恢复**: 程序异常退出后能正常重启

### 3.3 安全需求 (NFR-003)

#### 3.3.1 数据安全
- **敏感信息保护**: API Key 等敏感信息加密存储
- **数据传输**: 使用 HTTPS 协议传输数据
- **本地数据**: 不在本地存储敏感的代码diff信息

#### 3.3.2 访问控制
- **权限验证**: 检查 Git 仓库访问权限
- **环境隔离**: 不同项目的配置相互隔离
- **用户验证**: 验证当前用户的 Git 配置

### 3.4 可维护性需求 (NFR-004)

#### 3.4.1 代码质量
- **测试覆盖率**: 单元测试覆盖率 > 90%
- **代码规范**: 遵循 Rust 官方代码规范
- **文档完整性**: 所有公共 API 都有文档注释

#### 3.4.2 可扩展性
- **模块化设计**: 各功能模块相互独立，低耦合
- **插件支持**: 预留AI服务提供商扩展接口
- **配置扩展**: 支持新增配置项而不破坏兼容性

#### 3.4.3 监控和日志
- **结构化日志**: 使用结构化格式记录关键操作
- **性能监控**: 记录关键操作的耗时统计
- **错误追踪**: 详细的错误堆栈和上下文信息

## 4. 系统约束

### 4.1 技术约束

#### 4.1.1 运行环境
- **操作系统**: Linux, macOS, Windows
- **Rust 版本**: >= 1.70.0
- **Git 版本**: >= 2.0.0

#### 4.1.2 依赖要求
- **必需依赖**: Tokio, Reqwest, Clap, Serde
- **可选依赖**: 根据AI服务提供商而定
- **系统依赖**: Git 命令行工具

### 4.2 业务约束

#### 4.2.1 使用限制
- **Git 仓库**: 必须在有效的 Git 仓库中运行
- **暂存区**: 必须有暂存的变更内容
- **网络要求**: 使用云端AI服务时需要网络连接

#### 4.2.2 合规要求
- **开源协议**: 遵循 MIT 开源协议
- **数据处理**: 符合数据保护相关法规
- **API 使用**: 遵循各AI服务提供商的使用条款

## 5. 用户场景

### 5.1 主要用户角色

#### 5.1.1 个人开发者
**特征**: 独立开发项目，注重效率和代码质量
**需求**: 快速生成规范的提交信息，支持本地AI服务
**使用频率**: 每日多次

#### 5.1.2 团队开发者
**特征**: 在团队中协作开发，需要统一的提交规范
**需求**: 一致的提交信息格式，支持团队配置共享
**使用频率**: 每日多次

#### 5.1.3 开源贡献者
**特征**: 为多个开源项目贡献代码
**需求**: 快速适应不同项目的提交规范，多语言支持
**使用频率**: 每周数次

### 5.2 典型使用场景

#### 5.2.1 单文件小型修改
```bash
# 场景：修复一个简单的bug
git add src/main.rs
ai-commit
# 输出：fix(main): 修复空指针异常问题
```

#### 5.2.2 多文件功能开发
```bash
# 场景：添加新功能模块
git add src/auth/ src/models/ tests/
ai-commit
# 输出：feat(auth): 添加用户认证模块和相关测试
```

#### 5.2.3 大型重构变更
```bash
# 场景：重构整个模块
git add . 
ai-commit
# 检测到大型变更，自动生成摘要
# 输出：refactor(core): 重构核心模块架构提升性能
```

#### 5.2.4 版本发布标签
```bash
# 场景：发布新版本
ai-commit --new-tag v1.2.0 --tag-message "Release v1.2.0"
# 自动创建标签并推送
```

## 6. 系统集成

### 6.1 外部系统集成

#### 6.1.1 Git 集成
- **依赖**: Git 命令行工具
- **接口**: 通过系统命令调用
- **数据交换**: 标准输入输出

#### 6.1.2 AI 服务集成
- **协议**: HTTPS REST API
- **数据格式**: JSON
- **认证方式**: Bearer Token (API Key)

### 6.2 开发工具集成

#### 6.2.1 CI/CD 集成
- **GitHub Actions**: 自动化测试和发布
- **支持**: 跨平台构建和测试
- **发布**: 自动创建 Release 和二进制包

#### 6.2.2 包管理器集成
- **Cargo**: Rust 官方包管理器
- **支持**: 源码安装和依赖管理
- **发布**: Crates.io 包发布

## 7. 质量保证

### 7.1 测试策略

#### 7.1.1 测试层次
- **单元测试**: 测试各个模块的核心功能
- **集成测试**: 测试模块间的协作
- **端到端测试**: 测试完整的用户工作流

#### 7.1.2 测试覆盖
- **功能测试**: 覆盖所有核心功能需求
- **异常测试**: 覆盖各种错误场景
- **性能测试**: 验证性能需求达标
- **兼容性测试**: 验证多平台兼容性

### 7.2 质量标准

#### 7.2.1 代码质量
- **静态分析**: 使用 Clippy 进行代码检查
- **格式化**: 使用 rustfmt 统一代码格式
- **文档**: 所有公共API都有文档注释

#### 7.2.2 发布标准
- **测试通过**: 所有测试必须通过
- **性能达标**: 满足性能需求指标
- **文档完整**: 用户文档和API文档完整

## 8. 项目管理

### 8.1 开发里程碑

#### 8.1.1 MVP版本 (v0.1.0)
- 基础提交信息生成功能
- Ollama AI服务支持
- 基本配置管理

#### 8.1.2 增强版本 (v0.2.0)
- 多AI服务提供商支持
- 国际化功能
- 性能优化

#### 8.1.3 完整版本 (v1.0.0)
- 大文件智能处理
- Tag管理功能
- 完整的错误处理和用户体验

### 8.2 维护计划

#### 8.2.1 持续改进
- **用户反馈**: 收集和处理用户反馈
- **性能优化**: 持续优化系统性能
- **功能扩展**: 根据需求添加新功能

#### 8.2.2 技术债务
- **依赖更新**: 定期更新项目依赖
- **安全补丁**: 及时修复安全漏洞
- **代码重构**: 持续改进代码质量

---

*本文档将随着项目发展持续更新和完善。*