# 代码审查功能详解

ai-commit 提供了强大的代码审查功能，支持静态分析和 AI 增强分析两种模式，帮助开发者提升代码质量和开发效率。

## 🎯 功能概览

### 基础静态代码审查
- **多语言支持**: Rust、Go、JavaScript、TypeScript 及通用语言
- **智能特征检测**: 函数、类、结构体、接口等代码特征自动识别
- **多格式输出**: Markdown、JSON、Text 三种报告格式
- **灵活文件选择**: 支持全量 Git diff 分析或指定文件分析
- **自动报告优化**: 超长报告自动压缩，保持可读性

### 🤖 AI 增强代码审查
- **智能质量评分**: 整体质量、安全性、性能、可维护性多维度评分（1-10分）
- **语言特定规则**: 针对不同编程语言的专业审查规则
- **安全漏洞检测**: 识别潜在安全风险和最佳实践违规
- **性能优化建议**: 提供具体的性能改进方案
- **学习资源推荐**: 为发现的问题提供相关学习材料
- **静态分析集成**: 将静态分析结果融入 AI 审查

## 📋 命令参数详解

### 基础代码审查参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--code-review` | 启用代码审查功能 | false |
| `--review-format` | 输出格式：markdown/json/text | markdown |
| `--review-output` | 自定义输出文件路径 | 自动生成 |
| `--review-files` | 指定审查文件列表（逗号分隔） | Git diff 中的所有文件 |
| `--show-languages` | 仅显示语言统计信息 | false |

### AI 审查增强参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--ai-review` | 启用 AI 代码审查 | false |
| `--ai-review-type` | 审查类型：general/security/performance/architecture | general |
| `--ai-review-detail` | 详细程度：brief/detailed/comprehensive | detailed |
| `--ai-language-specific` | 启用语言特定规则 | true |
| `--ai-include-static` | 包含静态分析结果 | true |
| `--ai-review-lang` | 输出语言：zh/en | zh |

## 🚀 使用示例

### 基础代码审查

```bash
# 审查当前 Git diff 中的所有变更
ai-commit --code-review

# 输出 JSON 格式（适合 CI/CD 集成）
ai-commit --code-review --review-format json

# 自定义输出文件
ai-commit --code-review --review-output reports/code-review.md

# 审查指定文件
ai-commit --code-review --review-files "src/main.rs,lib/utils.go"

# 仅查看语言统计
ai-commit --show-languages
```

### AI 增强审查

```bash
# 启用 AI 代码审查
ai-commit --ai-review

# 专注安全审查
ai-commit --ai-review --ai-review-type security

# 性能专项审查
ai-commit --ai-review --ai-review-type performance

# 架构设计审查
ai-commit --ai-review --ai-review-type architecture

# 全面详细审查
ai-commit --ai-review --ai-review-detail comprehensive

# 简要审查（快速反馈）
ai-commit --ai-review --ai-review-detail brief

# AI 审查 + 自定义输出
ai-commit --ai-review --review-format json --review-output ci/ai-review.json
```

### 组合使用

```bash
# 静态分析 + AI 审查 + JSON 输出（CI/CD 推荐）
ai-commit --ai-review --review-format json --review-output reports/full-review.json

# 安全专项 + 详细分析 + 英文输出
ai-commit --ai-review --ai-review-type security --ai-review-detail comprehensive --ai-review-lang en
```

## 📊 报告结构详解

### 基础报告内容

#### 1. 📊 摘要统计
```markdown
- **总文件数**: 15
- **检测到的特征数**: 416
- **检测到的语言**:
  - rust: 10 个文件
  - go: 3 个文件
  - javascript: 2 个文件
```

#### 2. 🔍 变更模式分析
- 代码结构变更类型识别
- 依赖关系变更检测
- 函数/方法定义变更分析
- API 兼容性影响评估

#### 3. ⚠️ 风险评估
- 破坏性变更识别
- 依赖版本兼容性检查
- 模块可见性影响分析
- 核心逻辑变更风险评估

#### 4. 🧪 测试建议
- 语言特定的测试策略
- 单元测试覆盖建议
- 集成测试场景推荐
- 性能基准测试建议

#### 5. 📁 详细文件分析
每个文件的详细分析包括：
- 检测到的代码特征
- 特征类型和位置
- 作用域建议
- 潜在影响评估

### AI 增强报告内容

#### 6. 🤖 AI 质量评分
```json
{
  "overall_score": 8.5,
  "security_score": 9.0,
  "performance_score": 7.5,
  "maintainability_score": 8.0
}
```

#### 7. 🎯 关键问题识别
- 优先级排序的问题列表
- 具体问题描述和位置
- 影响程度评估
- 修复建议

#### 8. 💡 改进建议
- 代码质量提升建议
- 最佳实践推荐
- 重构建议
- 优化方案

#### 9. 📚 学习资源
- 相关文档链接
- 最佳实践指南
- 技术博客推荐
- 官方参考资料

## 🔧 支持的编程语言

### Rust
**检测特征**: 函数、方法、结构体、枚举、trait、impl 块、模块、use 语句、常量、静态变量、类型别名、宏、测试

**专业规则**:
- 所有权和借用检查
- 生命周期管理
- 错误处理模式
- 并发安全性
- 性能优化建议

### Go
**检测特征**: 包、函数、方法、结构体、接口、导入、常量、变量、类型定义、goroutine、channel、测试、基准测试

**专业规则**:
- 并发模式最佳实践
- 错误处理惯例
- 接口设计原则
- 内存管理
- 性能优化

### JavaScript/TypeScript
**检测特征**: 函数、类、导入/导出、箭头函数、接口（TS）、类型别名（TS）、枚举（TS）

**专业规则**:
- 类型安全（TypeScript）
- 异步编程模式
- 模块化设计
- 性能最佳实践
- 安全编码规范

### 通用语言
对于不在特定支持列表中的语言，提供基础的代码变更检测和通用最佳实践建议。

## 🔄 输出格式对比

### Markdown 格式
- **优点**: 可读性强，支持富文本，适合人工阅读
- **用途**: 开发者审查、文档存档、团队分享
- **特点**: 支持表格、列表、代码块、表情符号

### JSON 格式
- **优点**: 结构化数据，易于程序处理，支持工具集成
- **用途**: CI/CD 集成、自动化工具、数据分析
- **特点**: 完整的数据结构，支持嵌套对象和数组

### Text 格式
- **优点**: 纯文本，兼容性强，文件体积小
- **用途**: 日志记录、简单报告、终端显示
- **特点**: 简洁明了，无格式依赖

## 🎨 最佳实践

### 开发阶段
```bash
# 快速代码质量检查
ai-commit --ai-review --ai-review-detail brief

# 提交前全面审查
ai-commit --ai-review --ai-review-detail detailed
```

### CI/CD 集成
```yaml
# GitHub Actions 示例
- name: AI Code Review
  run: |
    ai-commit --ai-review --review-format json --review-output ci-reports/ai-review.json
    
- name: Upload Review Report
  uses: actions/upload-artifact@v3
  with:
    name: ai-code-review
    path: ci-reports/ai-review.json
```

### 安全审查
```bash
# 安全专项审查
ai-commit --ai-review --ai-review-type security --ai-review-detail comprehensive

# 结合静态分析工具
ai-commit --ai-review --ai-include-static=true --ai-review-type security
```

### 性能优化
```bash
# 性能专项分析
ai-commit --ai-review --ai-review-type performance --ai-review-detail detailed

# 架构设计审查
ai-commit --ai-review --ai-review-type architecture
```

## 📈 配置优化

### 环境变量配置
```bash
# .env 文件配置
AI_COMMIT_PROVIDER=deepseek
AI_COMMIT_DEEPSEEK_API_KEY=your-api-key
AI_COMMIT_DEBUG=true  # 启用调试模式查看详细过程
```

### 项目级配置
```bash
# 创建项目专用配置文件
echo "AI_COMMIT_PROVIDER=ollama" > .env
echo "AI_COMMIT_MODEL=qwen2.5:7b" >> .env
```

### 性能调优
- **小项目**: 使用 `--ai-review-detail brief` 获得快速反馈
- **大项目**: 使用 `--review-files` 指定关键文件
- **CI/CD**: 使用 JSON 格式和结构化输出

## 🔍 常见问题

### Q: AI 审查需要网络连接吗？
A: 如果使用 Ollama 本地模型，则不需要；如果使用 Deepseek/SiliconFlow 等云端服务，则需要网络连接。

### Q: 支持自定义审查规则吗？
A: 目前支持通过 `--ai-review-type` 选择不同的审查重点，未来版本将支持自定义规则配置。

### Q: 报告过长如何处理？
A: 系统会自动检测超过 10,000 字符的报告并进行智能压缩，保持关键信息的同时提升可读性。

### Q: 如何集成到现有 CI/CD 流程？
A: 使用 JSON 格式输出，配合 `--review-output` 参数指定文件路径，便于后续工具处理。

---

通过合理使用代码审查功能，可以显著提升代码质量、减少潜在问题、加速团队协作效率。建议根据项目特点和团队需求选择合适的审查模式和参数配置。