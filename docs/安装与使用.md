# ai-commit 安装与使用文档

## 一、环境准备

- 推荐操作系统：Linux、macOS（支持 Intel 与 Apple Silicon/M 系列）
- 需安装 [Rust](https://rustup.rs/) 工具链
- 需安装 git

---

## 二、源码安装

1. 克隆项目
  
   ```bash
   git clone <your-repo-url>
   cd ai-commit
   ```

2. 编译并安装

   ```bash
   cargo build --release
   # 可将二进制加入 PATH
   cp target/release/ai-commit ~/.cargo/bin/
   # 或直接运行
   ./target/release/ai-commit --help
   ```

---

## 三、二进制安装（推荐）

1. 前往 [GitHub Releases](https://github.com/costa92/ai-commit/releases) 页面，下载对应平台的二进制文件：
   - `ai-commit-x86_64-unknown-linux-gnu`（Linux）
   - `ai-commit-x86_64-apple-darwin`（macOS Intel）
   - `ai-commit-aarch64-apple-darwin`（macOS M 系列）
2. 赋予执行权限并加入 PATH
   ```bash
   chmod +x ai-commit-*
   mv ai-commit-* /usr/local/bin/ai-commit
   ```
3. 验证安装
   ```bash
   ai-commit --help
   ```

---

## 四、配置方法

### 配置优先级
配置系统支持多层级配置，按以下优先级加载（从高到低）：
1. **命令行参数**：`--provider deepseek`
2. **环境变量**：`AI_COMMIT_PROVIDER=deepseek`
3. **用户配置文件**：`~/.ai-commit/.env`
4. **项目配置文件**：`.env`
5. **默认值**：内置默认配置

### 配置文件位置
- **全局配置**：`~/.ai-commit/.env`（推荐，避免项目冲突）
- **项目配置**：项目根目录下的 `.env`（仅对当前项目生效）

### 完整配置示例
```env
# AI服务提供商配置
AI_COMMIT_PROVIDER=ollama          # ollama|deepseek|siliconflow
AI_COMMIT_MODEL=mistral            # 模型名称

# Ollama配置（本地服务，默认）
AI_COMMIT_OLLAMA_URL=http://localhost:11434/api/generate

# Deepseek配置（云端服务）
AI_COMMIT_DEEPSEEK_API_KEY=sk-your-deepseek-key
AI_COMMIT_DEEPSEEK_URL=https://api.deepseek.com/v1/chat/completions

# SiliconFlow配置（云端服务）
AI_COMMIT_SILICONFLOW_API_KEY=sk-your-siliconflow-key
AI_COMMIT_SILICONFLOW_URL=https://api.siliconflow.cn/v1/chat/completions

# 调试和国际化
AI_COMMIT_DEBUG=false              # 开启调试模式
AI_COMMIT_LANGUAGE=zh-cn           # 语言设置：zh-cn|zh-tw|en

# 自定义提示词模板
AI_COMMIT_PROMPT_PATH=./custom-prompt.txt
```

### 快速配置指南

#### 使用Ollama（本地，推荐新手）
```bash
# 1. 安装Ollama
curl -fsSL https://ollama.ai/install.sh | sh

# 2. 下载模型
ollama pull mistral

# 3. 创建配置文件
mkdir -p ~/.ai-commit
echo "AI_COMMIT_PROVIDER=ollama" > ~/.ai-commit/.env
echo "AI_COMMIT_MODEL=mistral" >> ~/.ai-commit/.env
```

#### 使用Deepseek（云端，响应快）
```bash
# 创建配置文件
mkdir -p ~/.ai-commit
cat > ~/.ai-commit/.env << EOF
AI_COMMIT_PROVIDER=deepseek
AI_COMMIT_MODEL=deepseek-chat
AI_COMMIT_DEEPSEEK_API_KEY=your-api-key-here
EOF
```

#### 使用SiliconFlow（云端，模型丰富）
```bash
# 创建配置文件
mkdir -p ~/.ai-commit
cat > ~/.ai-commit/.env << EOF
AI_COMMIT_PROVIDER=siliconflow
AI_COMMIT_MODEL=Qwen/Qwen2.5-7B-Instruct
AI_COMMIT_SILICONFLOW_API_KEY=your-api-key-here
EOF
```

---

## 五、常用命令

### 基础提交功能
```bash
# 生成提交信息并自动提交
ai-commit

# 跳过自动 git add（手动控制暂存）
ai-commit --no-add

# 提交后自动推送
ai-commit --push

# 指定AI服务提供商和模型
ai-commit --provider deepseek --model deepseek-chat
ai-commit -P siliconflow -m Qwen/Qwen2.5-7B-Instruct
```

### 标签管理功能
```bash
# 显示最新标签信息
ai-commit --show-tag

# 创建新标签（自动递增补丁版本）
ai-commit --new-tag --push

# 创建指定版本标签
ai-commit --new-tag v2.0.0 --push

# 创建标签并同时推送分支
ai-commit --new-tag --push --push-branches

# 创建标签时添加自定义备注
ai-commit --new-tag --tag-note "发布重要更新" --push
```

### Git Worktree管理
```bash
# 创建新的工作树
ai-commit --worktree-create feature/new-ui
ai-commit --worktree-create feature/auth --worktree-path ~/dev/auth-feature

# 列出所有工作树
ai-commit --worktree-list
ai-commit --worktree-list --worktree-verbose  # 详细模式
ai-commit --worktree-list --worktree-porcelain  # 机器可读格式

# 切换到指定工作树
ai-commit --worktree-switch feature/new-ui

# 删除指定工作树
ai-commit --worktree-remove feature/old-feature

# 清空除当前外的所有其他工作树
ai-commit --worktree-clear
```

### 调试和高级功能
```bash
# 开启调试模式（显示详细过程）
AI_COMMIT_DEBUG=true ai-commit

# 使用自定义提示词模板
AI_COMMIT_PROMPT_PATH=./custom-prompt.txt ai-commit

# 组合使用多个功能
ai-commit --worktree-create hotfix/critical --provider deepseek --push
```

### 参数说明
| 参数 | 简写 | 说明 | 默认值 |
|------|------|------|--------|
| `--provider` | `-P` | AI服务提供商 | ollama |
| `--model` | `-m` | AI模型名称 | mistral |
| `--no-add` | `-n` | 不自动执行git add | false |
| `--push` | `-p` | 提交后自动推送 | false |
| `--new-tag` | `-t` | 创建新标签 | - |
| `--tag-note` | - | 标签备注信息 | - |
| `--show-tag` | `-s` | 显示最新标签 | false |
| `--push-branches` | `-b` | 推送标签时同时推送分支 | false |
| `--worktree-create` | - | 创建新工作树 | - |
| `--worktree-switch` | - | 切换工作树 | - |
| `--worktree-list` | - | 列出工作树 | false |
| `--worktree-remove` | - | 删除工作树 | - |
| `--worktree-clear` | - | 清空其他工作树 | false |

> **提示**：
> - 所有参数均支持简写和全写形式
> - 可以组合使用多个参数
> - 工作树功能需要Git 2.5.0+版本支持

---

## 六、CI 产物下载与使用

- 每次发布 tag 后，GitHub Actions 会自动编译并上传以下平台的二进制文件：
  - Windows (x86_64): `ai-commit-x86_64-pc-windows-gnu.zip`
  - Linux (x86_64): `ai-commit-x86_64-unknown-linux-musl.tar.gz`
  - macOS Intel: `ai-commit-x86_64-apple-darwin.zip`
  - macOS ARM: `ai-commit-aarch64-apple-darwin.zip`
- 可在 [Releases](https://github.com/<your-org-or-user>/ai-commit/releases) 页面下载对应平台的二进制文件
- 所有二进制文件都经过压缩优化，体积更小
- 包含必要的文档和配置文件（README.md、LICENSE、commit-prompt.txt）

---

## 七、常见问题与解决方案

### AI服务问题
**Q: AI服务连接失败**
```bash
# 检查配置
AI_COMMIT_DEBUG=true ai-commit

# 验证API Key
echo $AI_COMMIT_DEEPSEEK_API_KEY

# 测试网络连接
curl -I https://api.deepseek.com
```

**Q: 生成的提交信息不符合规范**
- 检查`commit-prompt.txt`模板是否正确
- 尝试切换不同的AI模型
- 使用调试模式查看详细过程

**Q: 响应时间过长**
- 大型变更（>10K字符）会触发摘要模式，耗时较长属正常
- 可切换到本地Ollama服务提升速度
- 检查网络连接质量

### Git操作问题
**Q: 检测不到Git仓库**
```bash
# 检查当前目录
pwd
git status

# 初始化Git仓库
git init
git config user.name "Your Name"
git config user.email "your.email@example.com"
```

**Q: 没有暂存的变更**
```bash
# 查看文件状态
git status

# 添加变更到暂存区
git add .
# 或指定文件
git add src/main.rs
```

**Q: 工作树操作失败**
```bash
# 检查Git版本（需要2.5.0+）
git --version

# 检查现有工作树
git worktree list

# 清理无效的工作树引用
git worktree prune
```

### 配置问题
**Q: 配置文件不生效**
```bash
# 检查配置文件路径
ls -la ~/.ai-commit/.env
ls -la .env

# 验证环境变量
env | grep AI_COMMIT

# 使用调试模式查看配置加载
AI_COMMIT_DEBUG=true ai-commit --help
```

**Q: API Key验证失败**
- 确认API Key格式正确（通常以sk-开头）
- 检查API Key是否过期
- 验证服务提供商账户状态和余额

### 性能问题
**Q: 内存占用过高**
- 大型diff会消耗更多内存，属正常现象
- 可通过分批提交减少单次处理量
- 监控系统资源：`top -p $(pgrep ai-commit)`

**Q: 处理速度慢**
- 使用本地AI服务（Ollama）
- 启用调试模式查看耗时分布
- 检查网络延迟：`ping api.deepseek.com`

### 故障排除步骤
1. **启用调试模式**：`AI_COMMIT_DEBUG=true ai-commit`
2. **检查系统环境**：Git版本、网络连接、磁盘空间
3. **验证配置**：API Key、服务端点、模型名称
4. **查看日志**：检查错误信息和堆栈跟踪
5. **重置配置**：删除配置文件，使用默认设置测试

---

## 八、更多文档
- [需求文档](./需求文档.md)
- [技术文档](./技术文档.md) 