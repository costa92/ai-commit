# 查询历史 TUI 界面实现文档

## 概述

成功实现了类似 GRV (Git Repository Viewer) 的终端用户界面（TUI），用于交互式浏览和管理查询历史。该界面提供了丰富的视觉体验和键盘导航功能。

## 实现的功能

### 1. 核心TUI组件

#### 界面布局
```
┌─────────────────────────────────────┐
│        📜 Query History             │  <- 标题栏
├─────────────────────────────────────┤
│ ✅ 2025-09-08 19:04 [execute]      │  <- 历史列表
│    author:costa (176 results)       │
│ ✅ 2025-09-08 19:04 [execute]      │
│    type:fix (207 results)           │
├─────────────────────────────────────┤
│ Query: author:costa                 │  <- 详情面板
│ Time: 2025-09-08 19:04:42          │
│ Type: execute                       │
│ Results: 176                        │
│ Status: Success                     │
├─────────────────────────────────────┤
│ ↑↓: Navigate | Enter: Select | q: Quit │ <- 状态栏
└─────────────────────────────────────┘
```

### 2. 交互功能

#### 导航控制
- **↑/↓ 或 j/k**: 上下移动选择
- **g/G**: 跳到列表开头/结尾
- **PageUp/PageDown 或 f/b**: 翻页浏览
- **Enter**: 选择并执行查询
- **q/ESC**: 退出界面

#### 搜索功能
- **/**: 进入搜索模式
- **实时过滤**: 输入时即时过滤结果
- **ESC**: 取消搜索
- **Enter**: 应用搜索过滤

#### 视图控制
- **d**: 切换详情面板显示
- **动态布局**: 根据详情面板状态调整布局

### 3. 视觉设计

#### 颜色编码
- 🟢 **绿色**: 成功的查询
- 🔴 **红色**: 失败的查询
- 🟡 **黄色**: 当前选中项
- 🔵 **青色**: 标题和统计信息
- ⚪ **白色**: 边框和普通文本
- 🔘 **灰色**: 帮助文本

#### 状态图标
- ✅ 成功执行
- ❌ 执行失败
- 🔍 搜索模式

### 4. 技术实现

#### 使用的库
- **ratatui**: 现代的TUI框架
- **crossterm**: 跨平台终端控制

#### 模块结构
```rust
src/tui.rs
├── App          // 应用状态管理
├── run_tui()    // TUI主入口
├── run_app()    // 事件循环
├── ui()         // UI渲染
└── show_history_tui() // 公共接口
```

## 使用方法

### 启动TUI界面

```bash
# 直接启动TUI
ai-commit --query-tui

# 从命令行查看使用说明
ai-commit --help | grep query-tui
```

### 操作流程

1. **浏览历史**
   - 使用方向键或 j/k 浏览历史记录
   - 查看右侧详情面板了解查询详情

2. **搜索查询**
   - 按 `/` 进入搜索模式
   - 输入关键词实时过滤
   - 按 Enter 确认或 ESC 取消

3. **执行查询**
   - 选择要重新执行的查询
   - 按 Enter 执行
   - 自动退出TUI并显示结果

## 与原有功能的集成

### CLI参数集成
```bash
--query-history   # 文本模式查看历史
--query-stats     # 查看统计信息
--query-clear     # 清空历史
--query-browse    # 简单交互式浏览
--query-tui       # 完整TUI界面（新增）
```

### 数据共享
- 使用相同的 `QueryHistory` 后端
- 历史文件位置：`~/.ai-commit/query_history.json`
- 所有模式共享同一份历史数据

## 性能优化

1. **懒加载**: 只加载需要显示的历史条目
2. **增量渲染**: 只更新变化的UI部分
3. **异步处理**: 避免阻塞UI响应

## 错误处理

- **终端恢复**: 确保退出时恢复终端状态
- **优雅降级**: TUI不可用时自动回退到文本模式
- **错误提示**: 清晰的错误信息显示

## 对比 GRV

### 相似之处
- 类似的界面布局
- 键盘导航模式
- 实时搜索功能
- 详情面板设计

### 改进之处
- 更简洁的界面
- 更直观的状态显示
- 集成查询执行功能
- 统计信息显示

## 测试用例

```bash
# 1. 添加测试数据
ai-commit --query "author:test"
ai-commit --query "message:feat"
ai-commit --query "since:2024-01-01"

# 2. 启动TUI查看
ai-commit --query-tui

# 3. 测试搜索
# 在TUI中按 / 然后输入 "feat"

# 4. 测试执行
# 选择一个查询按 Enter
```

## 未来改进计划

1. **增强功能**
   - 支持删除单条历史记录
   - 支持编辑查询后执行
   - 支持导出选中的查询

2. **视觉改进**
   - 添加语法高亮
   - 支持主题切换
   - 添加图表统计

3. **交互增强**
   - 支持鼠标操作
   - 添加快捷键自定义
   - 支持批量操作

## 截图对比

### GRV 历史视图
- 多列信息显示
- 分支/标签/提交混合
- 复杂的颜色编码

### ai-commit TUI
- 专注于查询历史
- 清晰的成功/失败状态
- 简洁的操作界面

## 总结

成功实现了一个功能完整、界面美观的TUI界面，为查询历史管理提供了专业的可视化工具。该实现：

✅ 提供了类似GRV的专业界面体验
✅ 实现了完整的键盘导航
✅ 支持实时搜索和过滤
✅ 集成了查询执行功能
✅ 保持了良好的性能和响应

该TUI界面大大提升了查询历史功能的用户体验，使其更加直观和高效。