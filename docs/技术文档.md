# ai-commit 技术文档

## 一、项目架构

本项目采用 Rust 语言开发，结构高度模块化，便于维护和扩展。

```
src/
├── main.rs                    // 主流程入口和核心业务逻辑
├── lib.rs                     // 库入口，模块导出
├── cli/
│   ├── mod.rs                 // CLI模块导出
│   └── args.rs                // 命令行参数解析（支持worktree等高级功能）
├── config/
│   └── mod.rs                 // 配置管理（多层级配置、环境变量缓存）
├── ai/
│   ├── mod.rs                 // AI服务核心逻辑（多提供商支持）
│   ├── diff_analyzer.rs       // 智能差异分析器（大文件/多文件处理）
│   └── prompt.rs              // 提示词模板处理（缓存优化）
├── git/
│   ├── mod.rs                 // Git模块统一导出
│   ├── commit.rs              // Git基础操作（add/commit/push/diff）
│   ├── tag.rs                 // 标签管理（智能版本递增、缓存优化）
│   └── worktree.rs            // Git工作树管理（创建/切换/删除/列表）
├── internationalization.rs   // 国际化支持模块
tests/
├── integration_tests.rs      // 集成测试
commit-prompt.txt             // 提交提示词模板
example.env                   // 环境变量配置示例
```

---

## 二、模块说明

### 1. main.rs - 主程序入口

- **核心业务流程控制**：参数解析、worktree 操作、标签创建、提交处理
- **异步任务协调**：使用 tokio 处理并发操作
- **错误处理和用户交互**：统一的错误处理和用户友好的输出

### 2. cli/args.rs - 命令行参数解析

- **完整的参数支持**：
  - 基础功能：provider、model、no_add、push、show_tag、new_tag、push_branches
  - 高级功能：worktree 管理（创建、切换、删除、列表、清理）
  - 调试功能：详细输出控制、过期时间设置
- **参数验证**：支持简称和全称，灵活的参数组合
- **全面测试覆盖**：95 个单元测试确保参数解析正确性

### 3. config/mod.rs - 配置管理系统

- **多层级配置加载**：
  - 优先级：命令行参数 > 环境变量 > 用户配置 > 项目配置 > 默认值
  - 支持用户目录配置（~/.ai-commit/.env）和项目配置（.env）
- **性能优化**：
  - 环境变量缓存机制（单例模式）
  - 批量环境变量读取
- **配置验证**：启动时验证必要配置项，提供清晰的错误提示

### 4. ai/mod.rs - AI 服务核心

- **多提供商支持**：
  - Ollama（本地服务，默认）
  - Deepseek（云端 API）
  - SiliconFlow（云端 API）
- **性能优化**：
  - HTTP 客户端连接池复用（单例模式）
  - 流式响应处理，实时输出
  - 预编译正则表达式提升验证性能
- **智能响应处理**：
  - 自动清理和格式化 AI 响应
  - 严格的 Conventional Commits 规范验证
  - 中文字符长度限制（100 字符）

### 5. ai/diff_analyzer.rs - 智能差异分析器

- **大文件检测**：diff 内容超过 10,000 字符自动触发摘要模式
- **多文件处理**：超过 5 个文件的变更智能生成摘要
- **智能推断**：
  - 基于文件路径自动推断作用域（src/模块 > 顶级目录）
  - 基于变更模式推断类型（新增->feat，测试->test，文档->docs）
- **优化提示生成**：为大型变更创建专门的摘要化提示词

### 6. ai/prompt.rs - 提示词模板处理

- **模板缓存**：单例模式缓存提示词模板，避免重复读取
- **灵活配置**：支持自定义提示词路径（AI_COMMIT_PROMPT_PATH）
- **动态替换**：{{git_diff}}占位符动态插入差异内容
- **回退机制**：外部文件读取失败时使用内置模板

### 7. git/commit.rs - Git 基础操作

- **异步操作**：使用 tokio::process::Command 提升性能
- **批量操作**：并行执行 git status 和 git diff 提升效率
- **完整功能**：
  - `git_add_all`：添加所有文件到暂存区
  - `git_commit`：标准提交
  - `git_commit_allow_empty`：允许空提交（用于标签）
  - `git_push`：推送到远程
  - `get_git_diff`：获取暂存区差异

### 8. git/tag.rs - 智能标签管理

- **版本智能递增**：
  - 自动解析现有标签，智能递增版本号
  - 支持指定基础版本（如 v1.2.0）或自动递增补丁版本
  - 冲突检测和自动解决
- **缓存优化**：
  - 标签列表缓存（异步 Mutex）
  - 分支列表缓存，避免重复查询
- **推送策略**：
  - 安全推送：仅推送标签
  - 批量推送：可选同时推送 master、develop、main 分支

### 9. git/worktree.rs - Git 工作树管理

- **完整的工作树操作**：
  - 创建工作树（支持现有分支和新分支）
  - 切换工作树（智能路径匹配）
  - 删除工作树（支持强制删除和清理）
  - 列表显示（支持详细模式、机器可读格式）
- **高级功能**：
  - 批量清理其他工作树
  - 自定义工作树路径
  - 过期时间管理
- **Git 原生兼容**：支持所有 git worktree list 的原生选项

### 10. internationalization.rs - 国际化支持

- **多语言支持**：简体中文、繁体中文、英语
- **动态切换**：运行时语言切换
- **全面覆盖**：命令行帮助、错误信息、状态消息

---

## 三、主要依赖

### 核心依赖

- **`tokio`** (v1.0)：异步运行时，支持 full 特性集
- **`reqwest`** (v0.11)：HTTP 客户端，支持 JSON、TLS、流式处理
- **`clap`** (v4.0)：命令行参数解析，支持 derive 宏
- **`serde`** + **`serde_json`** (v1.0)：序列化与反序列化
- **`anyhow`** (v1.0)：统一错误处理
- **`dotenvy`** (v0.15)：环境变量加载

### 性能优化依赖

- **`once_cell`** (v1.19)：单例模式和延迟初始化
- **`regex`** (v1.0)：正则表达式处理（预编译优化）
- **`futures-util`** (v0.3)：异步流处理
- **`bytes`** (v1.5)：高效字节处理

### 开发测试依赖

- **`tempfile`** (v3.8)：临时文件测试
- **`tokio-test`** (v0.4)：异步测试工具
- **`futures`** (v0.3)：异步测试支持

---

## 四、核心流程

### 主流程控制

1. **初始化阶段**

   - 解析命令行参数（Args::parse）
   - 加载多层级配置（Config::new + update_from_args）
   - 验证配置完整性（config.validate）

2. **Worktree 操作处理**（优先级最高）

   - 检查是否为 worktree 相关操作
   - 执行相应操作：创建、切换、删除、列表、清理
   - 如果是 worktree 操作，直接返回

3. **标签信息显示**

   - 处理 --show-tag 参数
   - 获取最新标签和备注信息

4. **Git 变更处理**

   - （可选）执行 `git add .`（--no-add 控制）
   - 获取 `git diff --cached` 内容

5. **分支处理逻辑**
   - **标签模式**（--new-tag）：
     - 生成下一个标签名称
     - 根据是否有变更决定提交策略
     - 创建标签并可选推送
   - **提交模式**：
     - 检查是否有暂存变更
     - 进入 AI 生成流程

### AI 生成流程

1. **差异分析**

   - 使用 DiffAnalysis 分析变更规模
   - 检测大文件（>10K 字符）或多文件（>5 个）场景
   - 智能推断变更类型和作用域

2. **提示词优化**

   - 小型变更：使用原始提示词
   - 大型变更：生成摘要化提示词，避免文件名罗列

3. **AI 服务调用**

   - 根据配置选择 AI 提供商（Ollama/Deepseek/SiliconFlow）
   - 流式处理响应，实时显示生成过程
   - 性能监控：记录生成耗时

4. **响应验证和清理**

   - 验证 Conventional Commits 格式
   - 检查中文字符长度限制
   - 清理多余的代码块标记

5. **提交执行**
   - 执行 `git commit`
   - （可选）执行 `git push`

---

## 五、配置系统详解

### 配置优先级（从高到低）

1. **命令行参数**：`--provider deepseek --model gpt-4`
2. **环境变量**：`AI_COMMIT_PROVIDER=deepseek`
3. **用户配置文件**：`~/.ai-commit/.env`
4. **项目配置文件**：`.env`
5. **默认值**：内置默认配置

### 支持的配置项

```bash
# AI服务提供商配置
AI_COMMIT_PROVIDER=ollama          # ollama|deepseek|siliconflow
AI_COMMIT_MODEL=mistral            # 模型名称

# Ollama配置（本地服务）
AI_COMMIT_OLLAMA_URL=http://localhost:11434/api/generate

# Deepseek配置（云端服务）
AI_COMMIT_DEEPSEEK_API_KEY=sk-xxx  # 必需
AI_COMMIT_DEEPSEEK_URL=https://api.deepseek.com/v1/chat/completions

# SiliconFlow配置（云端服务）
AI_COMMIT_SILICONFLOW_API_KEY=sk-xxx  # 必需
AI_COMMIT_SILICONFLOW_URL=https://api.siliconflow.cn/v1/chat/completions

# 调试和国际化
AI_COMMIT_DEBUG=false              # true|false|1|0
AI_COMMIT_LANGUAGE=zh-cn           # zh-cn|zh-tw|en
```

### 配置加载机制

- **环境变量缓存**：使用单例模式缓存环境变量，避免重复读取
- **批量加载**：一次性读取所有相关环境变量
- **配置验证**：启动时验证必要配置项（如 API Key）
- **错误提示**：提供清晰的配置错误信息和解决建议

---

## 六、架构特性与扩展点

### 性能优化特性

1. **HTTP 客户端优化**

   - 连接池复用：最大 10 个空闲连接，30 秒超时
   - 单例模式：全局客户端实例复用
   - 流式处理：实时显示 AI 响应，提升用户体验

2. **内存管理优化**

   - 预分配缓冲区：字符串 2048 字节，流 8192 字节
   - 批量处理：4096 字节阈值批量处理流数据
   - 即时释放：及时清理中间缓冲区

3. **正则表达式优化**

   - 预编译：使用 once_cell 预编译常用正则表达式
   - 缓存匹配：避免重复编译和匹配

4. **Git 操作优化**
   - 异步执行：使用 tokio::process::Command
   - 结果缓存：标签和分支信息缓存
   - 并行操作：同时执行 git status 和 git diff

### 扩展点设计

1. **新增 AI 提供商**

   - 在`ai/mod.rs`的`generate_commit_message`函数中添加新的分支
   - 实现对应的请求和响应结构体
   - 添加配置验证逻辑

2. **自定义提交规范**

   - 修改`commit-prompt.txt`模板文件
   - 或通过`AI_COMMIT_PROMPT_PATH`环境变量指定自定义模板
   - 支持项目级和用户级模板

3. **扩展 Git 操作**

   - `git/commit.rs`：添加更多 Git 基础操作
   - `git/tag.rs`：扩展标签管理功能
   - `git/worktree.rs`：增强工作树管理

4. **扩展命令行参数**

   - 在`cli/args.rs`中添加新的参数定义
   - 在`config/mod.rs`中添加对应的配置处理
   - 在主流程中添加相应的处理逻辑

5. **国际化扩展**
   - 在`internationalization.rs`中添加新语言支持
   - 扩展消息键值对
   - 添加语言检测和切换逻辑

---

## 七、测试与质量保证

### 测试覆盖情况

- **总测试数量**：95 个单元测试
- **模块覆盖**：
  - `cli/args.rs`：42 个测试，覆盖所有参数解析场景
  - `config/mod.rs`：25 个测试，覆盖配置加载和验证
  - `ai/mod.rs`：12 个测试，覆盖 AI 服务交互
  - `ai/diff_analyzer.rs`：8 个测试，覆盖差异分析逻辑
  - `git/tag.rs`：15 个测试，覆盖标签管理功能
  - `git/worktree.rs`：20 个测试，覆盖工作树操作

### 测试策略

1. **单元测试**：测试各模块的核心功能
2. **集成测试**：测试模块间协作
3. **错误场景测试**：覆盖各种异常情况
4. **并发安全测试**：验证缓存和共享状态的线程安全性

### 代码质量工具

- **Clippy**：静态代码分析
- **rustfmt**：代码格式化
- **文档测试**：确保文档示例的正确性
- **性能基准测试**：监控关键操作的性能

---

## 八、高级功能详解

### Git Worktree 管理

ai-commit 提供了完整的 Git 工作树管理功能，支持多分支并行开发：

```bash
# 创建新的工作树
ai-commit --worktree-create feature/new-ui
ai-commit --worktree-create feature/auth --worktree-path ~/dev/auth

# 列出所有工作树
ai-commit --worktree-list
ai-commit --worktree-list --worktree-verbose  # 详细模式
ai-commit --worktree-list --worktree-porcelain  # 机器可读格式

# 切换工作树
ai-commit --worktree-switch feature/new-ui

# 删除工作树
ai-commit --worktree-remove feature/old-feature

# 批量清理其他工作树
ai-commit --worktree-clear
```

### 智能标签管理

支持语义化版本管理和智能版本递增：

```bash
# 自动递增补丁版本
ai-commit --new-tag --push

# 指定大版本，自动处理冲突
ai-commit --new-tag v2.0.0 --push

# 同时推送分支和标签
ai-commit --new-tag --push --push-branches
```

**版本递增逻辑**：

- 未指定版本：从最新标签递增 patch 版本
- 指定 major.minor：从.0 开始查找可用版本
- 冲突处理：自动递增直到找到可用版本

### 大文件智能处理

当检测到大型变更时，系统会自动：

1. 生成变更摘要而非详细列表
2. 智能推断主要变更类型和作用域
3. 避免在提交信息中罗列具体文件名
4. 突出整体变更目标

**触发条件**：

- 大文件：diff 内容 > 10,000 字符
- 多文件：涉及文件数 > 5 个

---

## 九、常见问题与故障排除

### AI 服务相关问题

1. **AI 服务不可用**

   - 检查网络连接和 API Key 配置
   - 验证服务端点 URL 是否正确
   - 查看调试输出：`AI_COMMIT_DEBUG=true ai-commit`

2. **响应格式不符合规范**

   - 检查`commit-prompt.txt`模板是否正确
   - 验证 AI 模型是否支持中文输出
   - 尝试切换不同的 AI 提供商

3. **响应时间过长**
   - 大型变更会触发摘要模式，耗时较长属正常现象
   - 可尝试切换到响应更快的 AI 服务
   - 检查网络延迟情况

### Git 操作问题

1. **Git 仓库检测失败**

   - 确认当前目录在有效的 Git 仓库中
   - 检查 Git 配置：`git config --list`
   - 验证暂存区是否有变更：`git status`

2. **工作树操作失败**

   - 确认 Git 版本支持 worktree 功能（>=2.5.0）
   - 检查目标路径权限
   - 验证分支名称是否有效

3. **标签创建失败**
   - 检查是否有标签创建权限
   - 验证标签名称格式是否正确
   - 确认远程仓库推送权限

### 配置问题

1. **配置加载失败**

   - 检查.env 文件格式和路径
   - 验证环境变量名称是否正确
   - 使用调试模式查看配置加载过程

2. **API Key 验证失败**
   - 确认 API Key 格式正确
   - 检查 API Key 是否过期
   - 验证服务提供商账户状态

### 性能问题

1. **内存占用过高**

   - 大型 diff 会消耗更多内存，属正常现象
   - 可通过分批提交减少单次处理量
   - 监控系统资源使用情况

2. **处理速度慢**
   - 启用 HTTP 连接复用
   - 使用本地 AI 服务（Ollama）
   - 检查网络连接质量
